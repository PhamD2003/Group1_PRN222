@model Group1_PRN222.Models.OrderTable
@{
    ViewData["Title"] = $"Chi ti·∫øt ƒë∆°n h√†ng #{Model.Id}";
    var payment = Model.Payments.FirstOrDefault();
    var shipping = Model.ShippingInfos.FirstOrDefault();
    var isPayPal = payment?.Method == "PayPal";
    var isCOD = payment?.Method == "COD";
}

<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/Order/History">L·ªãch s·ª≠ ƒë∆°n h√†ng</a></li>
            <li class="breadcrumb-item active">ƒê∆°n h√†ng #@Model.Id</li>
        </ol>
    </nav>

    <!-- Order Header -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h3 class="mb-2">üì¶ ƒê∆°n h√†ng #@Model.Id</h3>
                    <p class="text-muted mb-1">ƒê·∫∑t ng√†y: @Model.OrderDate?.ToString("dd/MM/yyyy HH:mm")</p>
                    <p class="mb-0">
                        <span class="badge bg-success fs-6 px-3 py-2">@Model.Status</span>
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="fs-4 text-danger fw-bold mb-2">
                        @Model.TotalPrice?.ToString("N0") ‚Ç´
                    </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-danger btn-sm" onclick="cancelOrder(@Model.Id)">
                            ‚ùå H·ªßy ƒë∆°n
                        </button>
                        <a href="/Return/Create/@Model.Id" class="btn btn-outline-warning btn-sm">
                            üîÑ Tr·∫£ h√†ng
                        </a>
                        <button class="btn btn-outline-info btn-sm" onclick="trackOrder('VN123456')">
                            üöö Theo d√µi
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="printOrder()">
                            üñ®Ô∏è In ƒë∆°n
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Order Items -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üõçÔ∏è S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t (@Model.OrderItems.Count m·∫∑t h√†ng)</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>S·∫£n ph·∫©m</th>
                                    <th class="text-center">S·ªë l∆∞·ª£ng</th>
                                    <th class="text-end">ƒê∆°n gi√°</th>
                                    <th class="text-end">Th√†nh ti·ªÅn</th>
                                    <th class="text-center">ƒê√°nh gi√°</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.OrderItems)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="@item.Product?.Images" alt="@item.Product?.Title"
                                                     class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                                <div>
                                                    <h6 class="mb-1">@item.Product?.Title</h6>
                                                    <small class="text-muted">@item.Product?.Category?.Name</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center align-middle">
                                            <span class="badge bg-light text-dark fs-6">@item.Quantity</span>
                                        </td>
                                        <td class="text-end align-middle">
                                            @item.UnitPrice?.ToString("N0") ‚Ç´
                                        </td>
                                        <td class="text-end align-middle fw-bold">
                                            @((item.UnitPrice * item.Quantity)?.ToString("N0")) ‚Ç´
                                        </td>
                                        <td class="text-center align-middle">
                                            <a href="/Review/Create?productId=@item.ProductId" class="btn btn-outline-warning btn-sm">
                                                ‚≠ê ƒê√°nh gi√°
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payment Information -->
            @if (payment != null)
            {
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üí≥ Th√¥ng tin thanh to√°n</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Ph∆∞∆°ng th·ª©c:</strong> @payment.Method</p>
                                <p class="mb-1"><strong>S·ªë ti·ªÅn:</strong> @payment.Amount?.ToString("N0") ‚Ç´</p>
                                <p class="mb-1"><strong>Tr·∫°ng th√°i:</strong>
                                    <span class="badge bg-success">@payment.Status</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Th·ªùi gian thanh to√°n:</strong></p>
                                <p class="mb-1">@payment.PaidAt?.ToString("dd/MM/yyyy HH:mm:ss")</p>
                                <small class="text-success">‚úÖ ƒê√£ thanh to√°n th√†nh c√¥ng</small>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Shipping Information -->
            @if (shipping != null)
            {
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üöö Th√¥ng tin v·∫≠n chuy·ªÉn</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>ƒê∆°n v·ªã v·∫≠n chuy·ªÉn:</strong> @shipping.Carrier</p>
                                <p class="mb-1"><strong>M√£ v·∫≠n ƒë∆°n:</strong>
                                    <code class="bg-light p-1 rounded">@shipping.TrackingNumber</code>
                                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyTrackingNumber('@shipping.TrackingNumber')">
                                        üìã Copy
                                    </button>
                                </p>
                                <p class="mb-1"><strong>Tr·∫°ng th√°i:</strong>
                                    <span class="badge bg-info">@shipping.Status</span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>D·ª± ki·∫øn giao h√†ng:</strong></p>
                                <p class="mb-1 text-primary fw-bold">@shipping.EstimatedArrival?.ToString("dd/MM/yyyy")</p>
                                <small class="text-warning fw-bold">‚ö° Giao h√†ng s·ªõm!</small>

                                <div class="mt-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="trackOrder('@shipping.TrackingNumber')">
                                        üîç Theo d√µi chi ti·∫øt
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Return Requests -->
            @if (Model.ReturnRequests.Any())
            {
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">üîÑ Y√™u c·∫ßu tr·∫£ h√†ng</h5>
                    </div>
                    <div class="card-body">
                        @foreach (var returnRequest in Model.ReturnRequests)
                        {
                            <div class="border rounded p-3 mb-2">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <p class="mb-1"><strong>L√Ω do:</strong> @returnRequest.Reason</p>
                                        <p class="mb-1"><strong>Ng√†y y√™u c·∫ßu:</strong> @returnRequest.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</p>
                                    </div>
                                    <div class="col-md-4 text-md-end">
                                        <span class="badge bg-warning fs-6">@returnRequest.Status</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Order Summary -->
            <div class="card shadow-sm mb-4 sticky-top" style="top: 20px;">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üìä T√≥m t·∫Øt ƒë∆°n h√†ng</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>T·∫°m t√≠nh (@Model.OrderItems.Count s·∫£n ph·∫©m):</span>
                        <span class="fw-bold">@Model.TotalPrice?.ToString("N0") ‚Ç´</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                        <span class="text-success fw-bold">Mi·ªÖn ph√≠</span>
                    </div>

                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <strong class="fs-5">T·ªïng c·ªông:</strong>
                        <strong class="fs-5 text-danger">@Model.TotalPrice?.ToString("N0") ‚Ç´</strong>
                    </div>

                    @if (payment != null)
                    {
                        <div class="bg-light p-2 rounded mb-3">
                            <small class="text-muted">Thanh to√°n: </small>
                            <strong>@payment.Method</strong>
                            <div class="small text-success">@payment.Status</div>
                        </div>
                    }

                    <!-- Quick Actions -->
                    <div class="d-grid gap-2">
                        <a href="/Order/History" class="btn btn-outline-primary btn-sm">
                            üìÇ ƒê∆°n h√†ng kh√°c
                        </a>
                        <a href="/Product" class="btn btn-success btn-sm">
                            üõçÔ∏è Mua th√™m
                        </a>
                        <button class="btn btn-outline-info btn-sm" onclick="contactSupport(@Model.Id)">
                            üí¨ Li√™n h·ªá h·ªó tr·ª£
                        </button>
                    </div>
                </div>
            </div>

            <!-- Delivery Address -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">üìç ƒê·ªãa ch·ªâ giao h√†ng</h6>
                </div>
                <div class="card-body">
                    <address class="mb-0">
                        <strong>@Model.Address?.FullName</strong><br>
                        üìû @Model.Address?.Phone<br>
                        üìç @Model.Address?.Street<br>
                        @Model.Address?.City, @Model.Address?.State<br>
                        @Model.Address?.Country
                    </address>
                </div>
            </div>

            <!-- Support Info -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">üÜò C·∫ßn h·ªó tr·ª£?</h6>
                </div>
                <div class="card-body text-center">
                    <div class="mb-2">
                        <strong>Hotline:</strong><br>
                        <a href="tel:1900123456" class="text-decoration-none">üìû 1900-123-456</a>
                    </div>
                    <div class="mb-2">
                        <strong>Email:</strong><br>
                        <a href="mailto:support@ebaystore.vn" class="text-decoration-none">‚úâÔ∏è support@ebaystore.vn</a>
                    </div>
                    <small class="text-muted">8:00 - 22:00 (Th·ª© 2 - CN)</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Order Modal -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">‚ùå H·ªßy ƒë∆°n h√†ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng <strong>#@Model.Id</strong>?</p>
                <div class="alert alert-warning">
                    <strong>L∆∞u √Ω:</strong> ƒê∆°n h√†ng ƒë√£ h·ªßy kh√¥ng th·ªÉ kh√¥i ph·ª•c.
                </div>
                <div class="mb-3">
                    <label class="form-label">L√Ω do h·ªßy ƒë∆°n:</label>
                    <select class="form-select" id="cancelReason">
                        <option value="">Ch·ªçn l√Ω do...</option>
                        <option value="changed_mind">ƒê·ªïi √Ω kh√¥ng mu·ªën mua</option>
                        <option value="wrong_item">ƒê·∫∑t nh·∫ßm s·∫£n ph·∫©m</option>
                        <option value="found_better_price">T√¨m ƒë∆∞·ª£c gi√° t·ªët h∆°n</option>
                        <option value="other">L√Ω do kh√°c</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Gi·ªØ ƒë∆°n h√†ng</button>
                <button type="button" class="btn btn-danger" onclick="confirmCancelOrder()">X√°c nh·∫≠n h·ªßy</button>
            </div>
        </div>
    </div>
</div>

<!-- Tracking Modal -->
<div class="modal fade" id="trackingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">üöö Theo d√µi v·∫≠n chuy·ªÉn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <strong>M√£ v·∫≠n ƒë∆°n: <span id="trackingNumber" class="text-primary"></span></strong>
                </div>
                <div id="trackingTimeline">
                    <div class="timeline">
                        <div class="timeline-item completed">
                            <div class="d-flex">
                                <div class="me-3">
                                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                                        ‚úì
                                    </div>
                                </div>
                                <div>
                                    <h6>‚úÖ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n</h6>
                                    <small class="text-muted">H√¥m qua, 14:30</small>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-item completed mt-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                                        ‚úì
                                    </div>
                                </div>
                                <div>
                                    <h6>üì¶ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ƒë√≥ng g√≥i</h6>
                                    <small class="text-muted">H√¥m qua, 16:45</small>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-item active mt-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                                        üöö
                                    </div>
                                </div>
                                <div>
                                    <h6>üöö ƒêang v·∫≠n chuy·ªÉn</h6>
                                    <small class="text-muted">H√¥m nay, 09:15</small>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-item mt-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <div class="bg-light text-dark rounded-circle d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                                        üìç
                                    </div>
                                </div>
                                <div>
                                    <h6>üìç Giao h√†ng th√†nh c√¥ng</h6>
                                    <small class="text-muted">D·ª± ki·∫øn: Ng√†y mai</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    function cancelOrder(orderId) {
        const modal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
        modal.show();
    }

    async function confirmCancelOrder() {
        const reason = document.getElementById('cancelReason').value;

        try {
            const response = await fetch('/Order/Cancel/@Model.Id', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({ reason: reason })
            });

            const result = await response.json();

            if (result.success) {
                bootstrap.Modal.getInstance(document.getElementById('cancelOrderModal')).hide();
                alert('‚úÖ ' + result.message);
                window.location.reload();
            } else {
                alert('‚ùå ' + result.message);
            }
        } catch (error) {
            alert('‚ùå C√≥ l·ªói x·∫£y ra: ' + error.message);
        }
    }

    function trackOrder(trackingNumber) {
        document.getElementById('trackingNumber').textContent = trackingNumber;
        const modal = new bootstrap.Modal(document.getElementById('trackingModal'));
        modal.show();
    }

    function copyTrackingNumber(trackingNumber) {
        navigator.clipboard.writeText(trackingNumber);

        // Show notification
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 m-3 alert alert-success';
        toast.innerHTML = 'üìã ƒê√£ copy m√£ v·∫≠n ƒë∆°n!';
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 2000);
    }

    function printOrder() {
        window.print();
    }

    function contactSupport(orderId) {
        const message = `Ch√†o anh/ch·ªã,\n\nT√¥i c·∫ßn h·ªó tr·ª£ v·ªÅ ƒë∆°n h√†ng #${orderId}.\n\nC·∫£m ∆°n!`;
        const mailtoLink = `mailto:support@ebaystore.vn?subject=H·ªó tr·ª£ ƒë∆°n h√†ng #${orderId}&body=${encodeURIComponent(message)}`;

        window.location.href = mailtoLink;
    }
</script>
}