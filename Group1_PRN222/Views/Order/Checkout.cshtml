@{
ViewData["Title"] = "Thanh to√°n ƒë∆°n h√†ng";
var cartItems = ViewBag.CartItems as List<Group1_PRN222.Models.CartItem>;
var subtotal = (decimal)ViewBag.Subtotal;
var shippingFee = (decimal)ViewBag.ShippingFee;
var total = (decimal)ViewBag.Total;
var defaultAddress = ViewBag.DefaultAddress as Group1_PRN222.Models.Address;
}

<div class="container mt-4">
    <!-- Progress Steps -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-center flex-fill">
                    <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        ‚úì
                    </div>
                    <div class="small mt-2">Gi·ªè h√†ng</div>
                </div>
                <div class="flex-fill">
                    <hr class="bg-success" style="height: 2px;">
                </div>
                <div class="text-center flex-fill">
                    <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        2
                    </div>
                    <div class="small mt-2 fw-bold">Thanh to√°n</div>
                </div>
                <div class="flex-fill">
                    <hr class="bg-secondary" style="height: 2px;">
                </div>
                <div class="text-center flex-fill">
                    <div class="bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        3
                    </div>
                    <div class="small mt-2">Ho√†n th√†nh</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Checkout Form -->
        <div class="col-lg-8">
            <form id="checkoutForm">
                <!-- ƒê·ªãa ch·ªâ giao h√†ng -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üìç ƒê·ªãa ch·ªâ giao h√†ng</h5>
                    </div>
                    <div class="card-body">
                        <input type="hidden" id="addressId" value="@defaultAddress.Id" />
                        <div class="p-3 border rounded bg-light">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="fw-bold mb-1">@defaultAddress.FullName</h6>
                                    <p class="mb-1 text-muted">üìû @defaultAddress.Phone</p>
                                    <p class="mb-1">üìç @defaultAddress.Street</p>
                                    <p class="mb-0">@defaultAddress.City, @defaultAddress.Country</p>
                                    <span class="badge bg-success mt-2">ƒê·ªãa ch·ªâ m·∫∑c ƒë·ªãnh</span>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="selectedAddress"
                                           value="@defaultAddress.Id" checked>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" disabled>
                                + Th√™m ƒë·ªãa ch·ªâ m·ªõi
                            </button>
                            <small class="text-muted d-block mt-1">
                                * Ch·ª©c nƒÉng qu·∫£n l√Ω ƒë·ªãa ch·ªâ s·∫Ω c√≥ sau khi Member 1 ho√†n th√†nh
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="paypal" value="PayPal" checked>
                                    <label class="form-check-label w-100" for="paypal">
                                        <div class="p-3 border rounded h-100">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3" style="font-size: 1.5rem;">üí≥</div>
                                                <div>
                                                    <h6 class="mb-1">PayPal</h6>
                                                    <small class="text-muted">Thanh to√°n an to√†n qua PayPal</small>
                                                    <br><small class="text-warning">üß™ (M√¥ ph·ªèng)</small>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="cod" value="COD">
                                    <label class="form-check-label w-100" for="cod">
                                        <div class="p-3 border rounded h-100">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3" style="font-size: 1.5rem;">üí∞</div>
                                                <div>
                                                    <h6 class="mb-1">Thanh to√°n khi nh·∫≠n h√†ng</h6>
                                                    <small class="text-muted">Tr·∫£ ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</small>
                                                    <br><small class="text-success">‚úÖ Mi·ªÖn ph√≠</small>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- PayPal Notice -->
                        <div id="paypalNotice" class="alert alert-info mt-3">
                            <strong>PayPal:</strong> B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang PayPal ƒë·ªÉ ho√†n t·∫•t thanh to√°n.
                            <br><small class="text-muted">ƒê√¢y l√† m√¥ ph·ªèng, kh√¥ng c√≥ giao d·ªãch th·∫≠t.</small>
                        </div>

                        <div id="codNotice" class="alert alert-warning mt-3 d-none">
                            <strong>COD:</strong> Vui l√≤ng chu·∫©n b·ªã s·ªë ti·ªÅn ch√≠nh x√°c khi nh·∫≠n h√†ng.
                            <br><small class="text-muted">Ph√≠ COD: Mi·ªÖn ph√≠</small>
                        </div>
                    </div>
                </div>

                <!-- Ghi ch√∫ ƒë∆°n h√†ng -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">üìù Ghi ch√∫ ƒë∆°n h√†ng</h5>
                    </div>
                    <div class="card-body">
                        <textarea id="orderNotes" class="form-control" rows="3"
                                  placeholder="Ghi ch√∫ cho ng∆∞·ªùi b√°n (t√πy ch·ªçn)..."></textarea>
                        <small class="text-muted">V√≠ d·ª•: Giao h√†ng sau 5h chi·ªÅu, g·ªçi tr∆∞·ªõc khi giao...</small>
                    </div>
                </div>
            </form>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üìã T√≥m t·∫Øt ƒë∆°n h√†ng</h5>
                </div>
                <div class="card-body">
                    <!-- Cart Items Summary -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2">S·∫£n ph·∫©m (@cartItems.Count m·∫∑t h√†ng)</h6>
                        <div style="max-height: 200px; overflow-y: auto;">
                            @foreach (var item in cartItems.Take(3)) // Hi·ªÉn th·ªã t·ªëi ƒëa 3 items
                            {
                            <div class="d-flex align-items-center mb-2 pb-2 border-bottom">
                                <img src="@item.ImageUrl" alt="@item.ProductName"
                                     class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                                <div class="flex-grow-1">
                                    <div class="fw-bold small">@item.ProductName</div>
                                    <div class="text-muted small">SL: @item.Quantity</div>
                                </div>
                                <div class="text-end">
                                    <small class="fw-bold">@item.TotalPrice.ToString("N0") ‚Ç´</small>
                                </div>
                            </div>
                            }
                            @if (cartItems.Count > 3)
                            {
                            <div class="text-center">
                                <small class="text-muted">v√† @(cartItems.Count - 3) s·∫£n ph·∫©m kh√°c...</small>
                            </div>
                            }
                        </div>
                    </div>

                    <!-- Price Breakdown -->
                    <div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>T·∫°m t√≠nh:</span>
                            <span class="fw-bold">@subtotal.ToString("N0") ‚Ç´</span>
                        </div>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                            @if (shippingFee > 0)
                            {
                            <span class="fw-bold">@shippingFee.ToString("N0") ‚Ç´</span>
                            }
                            else
                            {
                            <span class="text-success fw-bold">Mi·ªÖn ph√≠</span>
                            }
                        </div>

                        @if (shippingFee == 0 && subtotal >= 500000)
                        {
                        <div class="alert alert-success p-2 mb-2">
                            <small>üéâ Mi·ªÖn ph√≠ ship cho ƒë∆°n h√†ng t·ª´ 500.000‚Ç´</small>
                        </div>
                        }

                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong class="fs-5">T·ªïng c·ªông:</strong>
                            <strong class="fs-5 text-danger">@total.ToString("N0") ‚Ç´</strong>
                        </div>
                    </div>

                    <!-- Checkout Button -->
                    <button type="button" class="btn btn-success w-100 btn-lg mb-3" onclick="submitCheckout()">
                        <span id="checkoutBtnText">ƒê·∫∑t h√†ng ngay</span>
                        <span id="checkoutSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
                    </button>

                    <a href="/Cart" class="btn btn-outline-secondary w-100">
                        ‚Üê Quay l·∫°i gi·ªè h√†ng
                    </a>

                    <!-- Security Notice -->
                    <div class="mt-3 p-2 bg-light rounded">
                        <small class="text-muted">
                            üîí Th√¥ng tin c·ªßa b·∫°n ƒë∆∞·ª£c b·∫£o m·∫≠t v√† m√£ h√≥a
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!</h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="text-success" style="font-size: 48px;">üõçÔ∏è</div>
                </div>
                <h6>ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</h6>
                <p class="text-muted mb-2">M√£ ƒë∆°n h√†ng: <span id="orderIdDisplay" class="fw-bold text-primary"></span></p>
                <p class="small text-muted">B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn trang thanh to√°n trong gi√¢y l√°t...</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success" onclick="goToPayment()">
                    Thanh to√°n ngay
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let currentOrderId = 0;
    let currentPaymentMethod = 'PayPal';

    // Payment method change handler
    document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            currentPaymentMethod = this.value;
            updatePaymentNotice();
        });
    });

    function updatePaymentNotice() {
        const paypalNotice = document.getElementById('paypalNotice');
        const codNotice = document.getElementById('codNotice');

        if (currentPaymentMethod === 'PayPal') {
            paypalNotice.classList.remove('d-none');
            codNotice.classList.add('d-none');
        } else {
            paypalNotice.classList.add('d-none');
            codNotice.classList.remove('d-none');
        }
    }

    // Submit checkout
    async function submitCheckout() {
        const addressId = document.getElementById('addressId').value;
        const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
        const notes = document.getElementById('orderNotes').value;

        // Show loading
        const btn = document.querySelector('button[onclick="submitCheckout()"]');
        const btnText = document.getElementById('checkoutBtnText');
        const spinner = document.getElementById('checkoutSpinner');

        btnText.textContent = 'ƒêang x·ª≠ l√Ω...';
        spinner.classList.remove('d-none');
        btn.disabled = true;

        try {
            const response = await fetch('/Order/Checkout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    addressId: addressId,
                    paymentMethod: paymentMethod,
                    notes: notes
                })
            });

            const result = await response.json();

            if (result.success) {
                currentOrderId = result.orderId;
                document.getElementById('orderIdDisplay').textContent = '#' + result.orderId;

                // Show success modal
                const modal = new bootstrap.Modal(document.getElementById('successModal'));
                modal.show();

                // Auto redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = result.redirectUrl;
                }, 3000);

            } else {
                alert('L·ªói: ' + result.message);
                resetButton();
            }
        } catch (error) {
            alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
            resetButton();
        }
    }

    function resetButton() {
        const btn = document.querySelector('button[onclick="submitCheckout()"]');
        const btnText = document.getElementById('checkoutBtnText');
        const spinner = document.getElementById('checkoutSpinner');

        btnText.textContent = 'ƒê·∫∑t h√†ng ngay';
        spinner.classList.add('d-none');
        btn.disabled = false;
    }

    function goToPayment() {
        if (currentOrderId > 0) {
            window.location.href = `/Order/Payment/${currentOrderId}?method=${currentPaymentMethod}`;
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updatePaymentNotice();
    });
</script>
}